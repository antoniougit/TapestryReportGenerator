<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Tapestry reporting</title>
        <!-- prettier-ignore -->
        <style>
            .container,h1{display:-webkit-box;display:-ms-flexbox}.buttons,.container{-webkit-box-direction:normal}body{font-family:Verdana,sans-serif}p{margin:0;padding:0}h1{display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-decoration:underline;margin-bottom:80px}.container{display:flex;-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:0 auto;width:100%;height:100%}.buttons{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;margin:0 20px;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.report{font-weight:700;margin:.5em}.final,.sfmc{margin-top:30px}a.download:link,a.download:visited{display:inline-block;width:150px;text-align:center;padding:10px;color:#333;background-color:#fff;font-size:18px;border:1px solid red;text-decoration:none;-webkit-transition:.3s;-o-transition:.3s;transition:.3s;background:-o-linear-gradient(top,#f6f6f6 -50%,#dedede 110%);background:-webkit-gradient(linear,left top,left bottom,color-stop(-50%,#f6f6f6),color-stop(110%,#dedede));background:linear-gradient(top,#f6f6f6 -50%,#dedede 110%)}a.download:active,a.download:hover{color:red}#filesList{border:1px solid #000;padding:10px;min-height:150px;width:50%;font-size:14px}#filesList ol li{font-style:italic}
        </style>
    </head>

    <body>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.core.min.js"
            integrity="sha512-UhlYw//T419BPq/emC5xSZzkjjreRfN3426517rfsg/XIEC02ggQBb680V0VvP+zaDZ78zqse3rqnnI5EJ6rxA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <h1>Tapestry Reporting</h1>
        <div class="container">
            <div class="buttons">
                <p class="report ga">1. Upload GA report</p>
                <input
                    type="file"
                    accept=".xl*"
                    onchange="readGAFile(this.files)"
                />
                <p class="report sfmc">2. Upload SFMC report</p>
                <input
                    type="file"
                    accept=".xl*"
                    onchange="readSFMCFile(this.files)"
                />
                <p class="report final">3. Download the final report</p>
                <a
                    class="download"
                    href="#"
                    onclick='downloadCSV({ filename: "export.csv" });'
                    >Process files</a
                >
            </div>
            <div id="filesList">
                Selected files:
                <ol></ol>
            </div>
        </div>

        <script>
            window.onload = function () {
                if (typeof window.FileReader !== 'function') {
                    alert(`File API isn't supported on this browser yet.`);
                }
            };

            window.onerror = function () {
                alert('Please select the correct file!');
            };

            let fileData = {},
                GAData = {},
                results = [];

            function xlSerialToJsDate(date) {
                return new Date(
                    -2209075200000 + (date - (date < 61 ? 0 : 1)) * 86400000
                );
            }

            function readGAFile(file) {
                results = [];
                const ol = document.querySelector('#filesList ol');
                if (ol.childNodes.length > 1) {
                    ol.innerHTML = '';
                }

                for (let i = 0; i < file.length; i++) {
                    const name = file[i].name,
                        reader = new FileReader();

                    reader.onload = function (e) {
                        const data = e.target.result,
                            workbook = XLSX.read(data, {
                                type: 'binary',
                            });
                        const xlRowObj = XLSX.utils.sheet_to_row_object_array(
                            workbook.Sheets['Dataset1']
                        );

                        fileData = xlRowObj[0];

                        GAData = {
                            Conversions: fileData['Transactions'],
                            Revenue: fileData['Revenue'],
                        };

                        const li = document.createElement('li');
                        li.textContent = name;
                        ol.appendChild(li);
                    };
                    reader.readAsBinaryString(file[i]);
                }
            }

            function readSFMCFile(file) {
                results = [];
                const ol = document.querySelector('#filesList ol');
                if (ol.childNodes.length > 1) {
                    ol.innerHTML = '';
                }
                let campaignRow = 0;

                for (let i = 0; i < file.length; i++) {
                    const name = file[i].name,
                        reader = new FileReader();

                    reader.onload = function (e) {
                        const data = e.target.result,
                            workbook = XLSX.read(data, {
                                type: 'binary',
                            });

                        const sheet = workbook.Sheets[workbook.SheetNames[0]],
                            range = XLSX.utils.decode_range(sheet['!ref']);
                        for (
                            let rowNum = range.s.r;
                            rowNum <= range.e.r;
                            rowNum++
                        ) {
                            const secondCell =
                                sheet[
                                    XLSX.utils.encode_cell({ r: rowNum, c: 1 })
                                ];
                            if (
                                secondCell &&
                                secondCell.v === 'Email Content Name'
                            ) {
                                nameRow = rowNum;
                            } else if (
                                secondCell &&
                                secondCell.v === fileData['Campaign']
                            ) {
                                campaignRow = rowNum;
                                break;
                            }
                        }

                        const xlRowObj = XLSX.utils.sheet_to_row_object_array(
                            workbook.Sheets[workbook.SheetNames[0]],
                            { range: nameRow }
                        );
                        console.log(fileData);
                        fileData = xlRowObj[campaignRow - nameRow - 1];
                        console.log(fileData);

                        fileData['Send Date'] = new Date(
                            Date.UTC(0, 0, fileData['Send Date'] - 1)
                        )
                            .toLocaleDateString('en-GB', {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                            })
                            .split('/')
                            .join('-');

                        delete fileData['Email Unique Unsubscribes'];

                        resultObj = Object.assign(fileData, GAData);

                        results.push(resultObj);

                        const li = document.createElement('li');
                        li.textContent = name;
                        ol.appendChild(li);
                    };
                    reader.readAsBinaryString(file[i]);
                }
            }

            function convertToCSV(args) {
                let result = '',
                    counter,
                    keys,
                    columnDelimiter,
                    lineDelimiter,
                    data;

                data = args.data || null;
                if (data == null || !data.length) return null;

                columnDelimiter = args.columnDelimiter || ',';
                lineDelimiter = args.lineDelimiter || '\n';

                keys = Object.keys(data[0]);

                result += keys.join(columnDelimiter);
                result += lineDelimiter;

                data.forEach(function (item) {
                    counter = 0;
                    keys.forEach(function (key) {
                        if (counter > 0) result += columnDelimiter;

                        result += item[key];
                        counter++;
                    });
                    result += lineDelimiter;
                });
                return result;
            }

            function downloadCSV(args) {
                let data,
                    filename,
                    link,
                    csv = convertToCSV({
                        data: results,
                    });
                if (csv == null) return;

                filename = args.filename || 'export.csv';

                if (!csv.match(/^data:text\/csv/i)) {
                    csv = 'data:text/csv;charset=utf-8,' + csv;
                }
                data = encodeURI(csv);

                link = document.createElement('a');
                link.setAttribute('href', data);
                link.setAttribute('download', filename);
                link.click();
            }
        </script>
    </body>
</html>
