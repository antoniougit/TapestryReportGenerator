<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex,nofollow" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <title>Tapestry Report Merger</title>
        <meta
            name="google-signin-client_id"
            content="608858293726-kd126iiefgor24ikhvepdesecuo0udj6"
        />
        <meta
            name="google-signin-scope"
            content="https://www.googleapis.com/auth/analytics.readonly"
        />
        <!-- prettier-ignore -->
        <style>
            #file,#loader{position:absolute}#container,#file{width:100%;height:100%}#file,.button{cursor:pointer}.button:active,.button:hover{background-color:#bb362a}#account,#date{height:30px}.button,a.download:link,a.download:visited{display:inline-block;font-size:18px;text-decoration:none;text-align:center}#account,#date,#filesList{font-size:14px}#clickCounter,#container,#loader,.button,.select,h1{text-align:center}h3{font-weight:400;margin-bottom:20px}#loader{left:50%;top:50%;z-index:1;width:120px;height:120px;margin:-76px 0 0 -76px;border-radius:50%;border-top:16px solid #4285f4;border-right:16px solid #ea4335;border-bottom:16px solid #fbbc05;border-left:16px solid #34a853;-webkit-animation:2s linear infinite spin;animation:2s linear infinite spin;display:none}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}@keyframes spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.animate-bottom{position:relative;-webkit-animation-name:animateBottom;-webkit-animation-duration:1s;animation-name:animateBottom;animation-duration:1s}@-webkit-keyframes animateBottom{from{bottom:-100px;opacity:0}to{bottom:0;opacity:1}}@keyframes animateBottom{from{bottom:-100px;opacity:0}to{bottom:0;opacity:1}}.g-signin2>div{margin:0 auto 20px}.select{margin-bottom:30px}#sms{margin-left:30px}body{font-family:Verdana,sans-serif}p{margin:0;padding:0}#container{margin:0 auto}#campaignName{width:300px;height:20px}.options{margin:0 20px}.button{padding:10px 20px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;outline:0;color:#fff;background-color:#ea4335;border:none;border-radius:5px}.button:active{-webkit-transform:translateY(4px);-ms-transform:translateY(4px);transform:translateY(4px)}.report{font-weight:700;margin:.5em}#account,a.download:active,a.download:hover{color:red}#attentDiv,#sfmcDiv,.final{margin-top:30px}a.download:link,a.download:visited{width:150px;padding:10px;color:#333;background-color:#fff;border:1px solid red;-webkit-transition:.3s;-o-transition:.3s;transition:.3s;background:-o-linear-gradient(top,#f6f6f6 -50%,#dedede 110%);background:-webkit-gradient(linear,left top,left bottom,color-stop(-50%,#f6f6f6),color-stop(110%,#dedede));background:linear-gradient(top,#f6f6f6 -50%,#dedede 110%)}#filesList{border:1px solid #000;padding:10px;min-height:150px;width:50%}#filesList ol li{font-style:italic}#clickCounter{font-size:12px}.buttons{margin:20px 0}.download{margin-top:20px;font-size:24px;padding:20px;background-color:#34a853}.download:active,.download:hover{background-color:#2f974b}#container .options:first-of-type{border:1px solid #000;max-width:800px;margin:0 auto;padding-top:20px}.attent,.sfmc{position:relative;border:1px solid #ccc;border-radius:5px;display:inline-block;padding:30px 12px}.fileName{font-size:.85rem;color:#555}#file{top:0;left:0;opacity:0;display:block;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;font-size:0;text-indent:-100px}.attent>span,.sfmc>span{color:#ccc;font-size:14px;font-weight:400}
        </style>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.core.min.js"
            integrity="sha512-UhlYw//T419BPq/emC5xSZzkjjreRfN3426517rfsg/XIEC02ggQBb680V0VvP+zaDZ78zqse3rqnnI5EJ6rxA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
    </head>

    <body>
        <div id="loader"></div>
        <h1>Tapestry Report Merger</h1>
        <h3 id="clickCounter">
            Processed reports downloaded:
            <span style="font-weight: bold"></span>!
        </h3>
        <p class="g-signin2"></p>
        <div id="container" class="animate-bottom">
            <div class="options">
                <div class="select">
                    <input
                        type="radio"
                        id="email"
                        name="selection"
                        value="email"
                        checked
                        onclick="handleClick(this); showHide()"
                    />
                    <label for="email">Email</label>
                    <input
                        type="radio"
                        id="sms"
                        name="selection"
                        value="sms"
                        onclick="handleClick(this); showHide()"
                    />
                    <label for="sms">SMS</label>
                </div>
                <div>
                    <label for="account" class="report ga">GA account:</label>
                    <select
                        name="account"
                        id="account"
                        class="report account"
                        required
                    >
                        <option value="coachNA">Coach NA Retail Web</option>
                        <option value="coachUSout">Coach US Outlet Web</option>
                        <option value="coachUSret">Coach US Retail Web</option>
                        <option value="ksUSret">KS US Retail Web</option>
                        <option value="ksUSsur">KS US Surprise Web</option>
                        <option value="SWCanada">SW Canada Retail Web</option>
                        <option value="SWUS">SW US Retail Web</option>
                    </select>
                </div>
                <div>
                    <label for="campaignName" class="report campaign"
                        >Campaign Name:</label
                    >
                    <input
                        type="text"
                        id="campaignName"
                        name="campaignName"
                        required
                    />
                </div>
                <div>
                    <label for="date" class="report date">Start date:</label>
                    <input
                        type="date"
                        id="date"
                        name="date"
                        min="2022-01-01"
                        max="2022-12-31"
                        class="report date"
                        required
                    />
                </div>
                <div class="buttons">
                    <button
                        class="pull button"
                        type="button"
                        onclick="queryReports();"
                    >
                        Pull from GA
                    </button>
                </div>
            </div>
            <div class="options">
                <div id="sfmcDiv" style="display: block">
                    <label class="report sfmc" for="file"
                        >Upload SFMC report<br />
                        <span>(drag & drop here)</span>
                        <input
                            name="file"
                            id="file"
                            class="file"
                            type="file"
                            accept=".xl*"
                            onchange="readSFMCFile(this.files)"
                        />
                    </label>
                </div>
                <div id="attentDiv" style="display: none">
                    <label class="report attent" for="file"
                        >Upload Attentive report<br />
                        <span>(drag & drop here)</span>
                        <input
                            name="file"
                            id="file"
                            class="file"
                            type="file"
                            accept=".xl*"
                            onchange="readAttentFile(this.files)"
                        />
                    </label>
                </div>
                <p class="fileName"></p>
                <div class="buttons">
                    <button
                        class="download button"
                        onclick='downloadCSV({ filename: "export.csv" });'
                    >
                        Download Results!
                    </button>
                </div>
            </div>
        </div>

        <script>
            Date.prototype.toDateInputValue = function () {
                var local = new Date(this);
                local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
                return local.toJSON().slice(0, 10);
            };

            document.getElementById('date').max = new Date().toDateInputValue();
            document.getElementById('date').value =
                new Date().toDateInputValue();

            window.onload = function () {
                countClicks('info');
                const check = sessionStorage.getItem('check');
                if (check === 'sms') {
                    document.getElementById('sms').checked = true;
                    showHide();
                }
                if (typeof window.FileReader !== 'function') {
                    alert('File API not supported on this browser yet.');
                }
            };

            window.onerror = function () {
                alert('Please select the correct file!');
            };

            const file = document.getElementById('file');
            file.addEventListener('change', (e) => {
                if (Object.keys(GAData).length === 0) {
                    return;
                }
                const [file] = e.target.files;
                const { name: fileName, size } = file;
                const fileSize = (size / 1000).toFixed(2);
                const fileNameAndSize = `${fileName} - ${fileSize}KB`;
                document.querySelector('.fileName').textContent =
                    fileNameAndSize;
            });

            function handleClick(checkButton) {
                const checkButtonId = checkButton.id;
                sessionStorage.setItem('check', checkButtonId);
            }

            function countClicks(endpoint) {
                const xhr = new XMLHttpRequest();
                xhr.open(
                    'GET',
                    `https://api.countapi.xyz/${endpoint}/tapestryreportmerger/reports`
                );
                xhr.responseType = 'json';
                if (endpoint === 'info') {
                    xhr.onload = function () {
                        document.querySelector(
                            '#clickCounter > span'
                        ).textContent = this.response.value;
                    };
                }
                xhr.send();
            }

            function showHide() {
                const email = document.getElementById('email'),
                    sfmcDiv = document.getElementById('sfmcDiv'),
                    attentDiv = document.getElementById('attentDiv');
                sfmcDiv.style.display = email.checked ? 'block' : 'none';
                attentDiv.style.display = email.checked ? 'none' : 'block';
            }

            let startTime,
                endTime = 0;

            function reportStart() {
                document.getElementById('container').style.display = 'none';
                document.getElementById('loader').style.display = 'block';
                startTime = performance.now();
            }

            function reportEnd() {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('container').style.display = 'block';
                endTime = performance.now();
                console.log(
                    `GA API call took ${((endTime - startTime) / 1000).toFixed(
                        2
                    )} seconds`
                );
            }

            function dateIncrement(date, increment) {
                var parts = date.split('-');
                var dt = new Date(
                    parseInt(parts[0], 10),
                    parseInt(parts[1], 10) - 1,
                    parseInt(parts[2], 10)
                );
                dt.setDate(dt.getDate() + increment);
                parts[0] = '' + dt.getFullYear();
                parts[1] = '' + (dt.getMonth() + 1);
                if (parts[1].length < 2) {
                    parts[1] = '0' + parts[1];
                }
                parts[2] = '' + dt.getDate();
                if (parts[2].length < 2) {
                    parts[2] = '0' + parts[2];
                }
                return parts.join('-');
            }

            function queryReports() {
                reportStart();

                const account = document.querySelector('#account').value;
                let VIEW_ID = '249300291';

                switch (account) {
                    case 'coachNA':
                        VIEW_ID = '249300291';
                        break;
                    case 'coachUSout':
                        VIEW_ID = '238100595';
                        break;
                    case 'coachUSret':
                        VIEW_ID = '234177249';
                        break;
                    case 'ksUSret':
                        VIEW_ID = '255937198';
                        break;
                    case 'ksUSsur':
                        VIEW_ID = '255935277';
                        break;
                    case 'SWCanada':
                        VIEW_ID = '231373074';
                        break;
                    case 'SWUS':
                        VIEW_ID = '231367597';
                        break;
                }

                const startDate =
                        document.querySelector('input[type="date"]').value,
                    endDate = dateIncrement(startDate, 3),
                    campaignName =
                        document.querySelector('#campaignName').value;

                gapi.client
                    .request({
                        path: '/v4/reports:batchGet',
                        root: 'https://analyticsreporting.googleapis.com/',
                        method: 'POST',
                        body: {
                            reportRequests: [
                                {
                                    viewId: VIEW_ID,
                                    samplingLevel: 'LARGE',
                                    dateRanges: [
                                        {
                                            startDate,
                                            endDate,
                                        },
                                    ],
                                    metrics: [
                                        {
                                            expression: 'ga:users',
                                        },
                                        {
                                            expression: 'ga:transactions',
                                        },
                                        {
                                            expression: 'ga:transactionRevenue',
                                        },
                                    ],
                                    // metricFilterClauses: [
                                    //     {
                                    //         filters: [
                                    //             {
                                    //                 metricName:
                                    //                     'ga:transactions',
                                    //                 operator: 'GREATER_THAN',
                                    //                 comparisonValue: '0',
                                    //             },
                                    //         ],
                                    //     },
                                    // ],
                                    dimensions: [
                                        {
                                            name: 'ga:campaign',
                                        },
                                        // {
                                        //     name: 'ga:dimension56',
                                        // },
                                    ],
                                    dimensionFilterClauses: [
                                        {
                                            filters: [
                                                {
                                                    dimensionName:
                                                        'ga:campaign',
                                                    operator: 'PARTIAL',
                                                    expressions: [campaignName],
                                                },
                                            ],
                                        },
                                        // {
                                        //     operator: 'AND',
                                        //     filters: [
                                        //         {
                                        //             dimensionName:
                                        //                 'ga:campaign',
                                        //             operator: 'PARTIAL',
                                        //             expressions: [campaignName],
                                        //         },
                                        //         {
                                        //             dimensionName:
                                        //                 'ga:dimension56',
                                        //             operator: 'EXACT',
                                        //             expressions: ['1'],
                                        //         },
                                        //     ],
                                        // },
                                    ],
                                },
                            ],
                        },
                    })
                    .then(readGA, console.error.bind(console));
            }

            let fileData = {},
                GAData = {},
                results = [];

            function readGA(response) {
                GAResults = [];

                const rows = response.result.reports[0].data.rows;

                for (let i = 0; i < rows.length; i++) {
                    GAResults[i] = {
                        Campaign: rows[i].dimensions[0],
                        Users: Number(rows[i].metrics[0].values[0]),
                        Transactions: Number(rows[i].metrics[0].values[1]),
                        Revenue: Number(rows[i].metrics[0].values[2]),
                    };
                }

                let conversions = 0,
                    revenue = 0;

                if (document.getElementById('sms').checked) {
                    for (const key in GAResults) {
                        fileData[key] = GAResults[key];
                    }
                    GAData = Object.assign({}, fileData);
                } else
                    for (const key in GAResults) {
                        fileData[key] = GAResults[key];
                        conversions += fileData[key]['Transactions'];
                        revenue += fileData[key]['Revenue'];

                        GAData = {
                            Conversions: conversions,
                            Revenue: revenue,
                        };
                    }
                reportEnd();
                console.log('fileData:', fileData);
                console.log('GAData:', GAData);
            }

            function readSFMCFile(file) {
                if (Object.keys(GAData).length === 0) {
                    alert('Please pull the GA results first!');
                    return;
                }
                let SFMCData = {};
                let deliveries = 0,
                    opens = 0,
                    clicks = 0;

                let campaignRow = [],
                    nameRow = 0;
                const dataLength = Object.keys(fileData).length;

                for (let i = 0; i < file.length; i++) {
                    const name = file[i].name,
                        reader = new FileReader();
                    reader.onload = function (e) {
                        const data = e.target.result,
                            workbook = XLSX.read(data, {
                                type: 'binary',
                            });

                        const sheet = workbook.Sheets[workbook.SheetNames[0]],
                            range = XLSX.utils.decode_range(sheet['!ref']);

                        if (dataLength > 1) {
                            for (
                                let rowNum = range.s.r;
                                rowNum <= range.e.r;
                                rowNum++
                            ) {
                                const secondCell =
                                    sheet[
                                        XLSX.utils.encode_cell({
                                            r: rowNum,
                                            c: 1,
                                        })
                                    ];
                                if (
                                    secondCell &&
                                    secondCell.v === 'Email Content Name'
                                ) {
                                    nameRow = rowNum;
                                } else {
                                    for (const key in fileData) {
                                        if (
                                            secondCell &&
                                            secondCell.v ===
                                                fileData[key]['Campaign']
                                        ) {
                                            campaignRow[key] = rowNum;
                                            const xlRowObj =
                                                XLSX.utils.sheet_to_row_object_array(
                                                    workbook.Sheets[
                                                        workbook.SheetNames[0]
                                                    ],
                                                    { range: nameRow }
                                                );
                                            fileData[key] =
                                                xlRowObj[
                                                    campaignRow[key] -
                                                        nameRow -
                                                        1
                                                ];
                                            deliveries +=
                                                fileData[key][
                                                    'Email Deliveries'
                                                ];
                                            opens +=
                                                fileData[key][
                                                    'Email Unique Opens'
                                                ];
                                            clicks +=
                                                fileData[key][
                                                    'Email Unique Clicks'
                                                ];
                                        }
                                    }
                                }
                            }
                        } else {
                            for (
                                let rowNum = range.s.r;
                                rowNum <= range.e.r;
                                rowNum++
                            ) {
                                const secondCell =
                                    sheet[
                                        XLSX.utils.encode_cell({
                                            r: rowNum,
                                            c: 1,
                                        })
                                    ];
                                if (
                                    secondCell &&
                                    secondCell.v === 'Email Content Name'
                                ) {
                                    nameRow = rowNum;
                                } else if (
                                    secondCell &&
                                    secondCell.v === fileData[0]['Campaign']
                                ) {
                                    campaignRow.push(rowNum);
                                }
                            }

                            const xlRowObj =
                                XLSX.utils.sheet_to_row_object_array(
                                    workbook.Sheets[workbook.SheetNames[0]],
                                    { range: nameRow }
                                );

                            for (let j = 0; j < campaignRow.length; j++) {
                                fileData[j] =
                                    xlRowObj[campaignRow[j] - nameRow - 1];
                                deliveries += fileData[j]['Email Deliveries'];
                                opens += fileData[j]['Email Unique Opens'];
                                clicks += fileData[j]['Email Unique Clicks'];
                            }
                        }

                        SFMCData = {
                            'Email Deliveries': deliveries,
                            'Email Unique Opens': opens,
                            'Email Unique Clicks': clicks,
                        };

                        delete fileData[0]['Email Unique Unsubscribes'];

                        fileData[0]['Send Date'] = new Date(
                            Date.UTC(0, 0, fileData[0]['Send Date'] - 1)
                        )
                            .toLocaleDateString('en-GB', {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                            })
                            .split('/')
                            .join('-');

                        if (document.getElementById('email').checked) {
                            if (dataLength > 1) {
                                const lastIndex =
                                    fileData[0][
                                        'Email Content Name'
                                    ].lastIndexOf('-');
                                fileData[0]['Email Content Name'] = fileData[0][
                                    'Email Content Name'
                                ].substring(0, lastIndex);
                                fileData[0]['Email Job ID'] = '';
                            }
                        }

                        const resultObj = Object.assign(
                            fileData[0],
                            SFMCData,
                            GAData
                        );

                        results.push(resultObj);
                    };
                    reader.readAsBinaryString(file[i]);
                }
            }

            function readAttentFile(file) {
                const attentData = Object.assign({}, fileData);

                let campaignRow = [];

                for (let i = 0; i < file.length; i++) {
                    const name = file[i].name,
                        reader = new FileReader();
                    reader.onload = function (e) {
                        const data = e.target.result,
                            workbook = XLSX.read(data, {
                                type: 'binary',
                            });

                        const sheet = workbook.Sheets[workbook.SheetNames[0]],
                            range = XLSX.utils.decode_range(sheet['!ref']);

                        for (
                            let rowNum = range.s.r;
                            rowNum <= range.e.r;
                            rowNum++
                        ) {
                            const secondCell =
                                sheet[
                                    XLSX.utils.encode_cell({ r: rowNum, c: 1 })
                                ];

                            for (const key in fileData) {
                                if (
                                    secondCell &&
                                    secondCell.v
                                        .toLowerCase()
                                        .includes(
                                            attentData[key]['Campaign']
                                                .toLowerCase()
                                                .replace(/\s+/g, '')
                                        )
                                ) {
                                    campaignRow[key] = rowNum;
                                    const xlRowObj =
                                        XLSX.utils.sheet_to_row_object_array(
                                            workbook.Sheets[
                                                workbook.SheetNames[0]
                                            ]
                                        );
                                    fileData[key] =
                                        xlRowObj[campaignRow[key] - 1];

                                    delete fileData[key]['Campaign Tags'];

                                    const dataLength =
                                        Object.keys(fileData).length;

                                    if (
                                        fileData[key]['Message Name']
                                            .toLowerCase()
                                            .includes('variant')
                                    ) {
                                        fileData[key]['Message Name'] =
                                            fileData[key][
                                                'Message Name'
                                            ].replace(/variant/gi, ' VRNT');
                                    } else if (
                                        fileData[key]['Message Name']
                                            .toLowerCase()
                                            .includes('cntrl')
                                    ) {
                                        fileData[key]['Message Name'] =
                                            fileData[key][
                                                'Message Name'
                                            ].replace(/cntrl/gi, ' CTRL');
                                    }

                                    fileData[key]['Conversions'] =
                                        GAData[key]['Transactions'];
                                    fileData[key]['Revenue ($)'] =
                                        GAData[key]['Revenue'];

                                    const resultObj = Object.assign(
                                        fileData[key]
                                    );
                                    results.push(resultObj);
                                }
                            }
                        }
                    };
                    reader.readAsBinaryString(file[i]);
                }
            }

            function convertToCSV(args) {
                let result = '',
                    counter,
                    keys,
                    columnDelimiter,
                    lineDelimiter,
                    data;

                data = args.data || null;
                if (data == null || !data.length) return null;

                columnDelimiter = args.columnDelimiter || ',';
                lineDelimiter = args.lineDelimiter || '\n';

                keys = Object.keys(data[0]);

                result += keys.join(columnDelimiter);
                result += lineDelimiter;

                data.forEach(function (item) {
                    counter = 0;
                    keys.forEach(function (key) {
                        if (counter > 0) result += columnDelimiter;
                        result += item[key];
                        counter++;
                    });
                    result += lineDelimiter;
                });
                return result;
            }

            function downloadCSV(args) {
                let data,
                    filename,
                    link,
                    csv = convertToCSV({
                        data: results,
                    });

                if (csv == null) {
                    alert('Please upload the 2 reports first!');
                    return;
                }

                filename = args.filename || 'export.csv';

                if (!csv.match(/^data:text\/csv/i)) {
                    csv = 'data:text/csv;charset=utf-8,' + csv;
                }

                data = encodeURI(csv);
                link = document.createElement('a');
                link.setAttribute('href', data);
                link.setAttribute('download', filename);
                link.click();
                location.reload();
                countClicks('hit');
            }
        </script>
        <script src="https://apis.google.com/js/client:platform.js"></script>
    </body>
</html>
