<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex,nofollow" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <title>Tapestry Report Merger</title>
        <!-- prettier-ignore -->
        <style>
            .container,h1{display:flex;display:-webkit-box;display:-ms-flexbox}h1{text-align:center}h3{font-weight:normal;margin-bottom:30px}.buttons,.container{-webkit-box-direction:normal}.select{margin-bottom:30px}#sms{margin-left:30px}body{font-family:Verdana,sans-serif}p{margin:0;padding:0}h1{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-decoration:underline}.container{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:0 auto;width:100%;height:100%}.buttons{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;margin:0 20px;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.report{font-weight:700;margin:.5em}.final,.sfmc,.attent{margin-top:30px}a.download:link,a.download:visited{display:inline-block;width:150px;text-align:center;padding:10px;color:#333;background-color:#fff;font-size:18px;border:1px solid red;text-decoration:none;-webkit-transition:.3s;-o-transition:.3s;transition:.3s;background:-o-linear-gradient(top,#f6f6f6 -50%,#dedede 110%);background:-webkit-gradient(linear,left top, left bottom,color-stop(-50%, #f6f6f6),color-stop(110%, #dedede));background:linear-gradient(top,#f6f6f6 -50%,#dedede 110%)}a.download:active,a.download:hover{color:red}#filesList{border:1px solid #000;padding:10px;min-height:150px;width:50%;font-size:14px}#filesList ol li{font-style:italic}#clickCounter{text-align:center;font-size:12px}
            </style>
    </head>

    <body>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.core.min.js"
            integrity="sha512-UhlYw//T419BPq/emC5xSZzkjjreRfN3426517rfsg/XIEC02ggQBb680V0VvP+zaDZ78zqse3rqnnI5EJ6rxA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <h1>Tapestry Report Merger</h1>
        <h3 id="clickCounter">
            Processed reports downloaded:
            <span style="font-weight: bold"></span>!
        </h3>
        <div class="container">
            <div class="buttons">
                <div class="select">
                    <input
                        type="radio"
                        id="email"
                        name="selection"
                        value="email"
                        checked
                        onclick="handleClick(this); showHide()"
                    />
                    <label for="email">Email</label>
                    <input
                        type="radio"
                        id="sms"
                        name="selection"
                        value="sms"
                        onclick="handleClick(this); showHide()"
                    />
                    <label for="sms">SMS</label>
                </div>
                <p class="report ga">1. Upload GA report</p>
                <input
                    type="file"
                    accept=".xl*"
                    onchange="readGAFile(this.files)"
                />
                <div id="sfmcDiv" style="display: block">
                    <p class="report sfmc">2. Upload SFMC report</p>
                    <input
                        type="file"
                        accept=".xl*"
                        onchange="readSFMCFile(this.files)"
                    />
                </div>
                <div id="attentDiv" style="display: none">
                    <p class="report attent">2. Upload Attentive report</p>
                    <input
                        type="file"
                        accept=".xl*"
                        onchange="readAttentFile(this.files)"
                    />
                </div>
                <p class="report final">3. Download the final report</p>
                <a
                    class="download"
                    href="#"
                    onclick='downloadCSV({ filename: "export.csv" });'
                    >Process files</a
                >
            </div>
            <div id="filesList">
                Selected files:
                <ol></ol>
            </div>
        </div>

        <script>
            window.onload = function () {
                countClicks('info');
                const check = sessionStorage.getItem('check');
                if (check === 'sms') {
                    document.getElementById('sms').checked = true;
                    showHide();
                }
                if (typeof window.FileReader !== 'function') {
                    alert('File API not supported on this browser yet.');
                }
            };

            window.onerror = function () {
                alert('Please select the correct file!');
            };

            function handleClick(checkButton) {
                const checkButtonId = checkButton.id;
                sessionStorage.setItem('check', checkButtonId);
            }

            function countClicks(endpoint) {
                const xhr = new XMLHttpRequest();
                xhr.open(
                    'GET',
                    `https://api.countapi.xyz/${endpoint}/tapestryreportmerger/reports`
                );
                xhr.responseType = 'json';
                if (endpoint === 'info') {
                    xhr.onload = function () {
                        document.querySelector(
                            '#clickCounter > span'
                        ).textContent = this.response.value;
                    };
                }
                xhr.send();
            }

            function showHide() {
                const email = document.getElementById('email'),
                    sfmcDiv = document.getElementById('sfmcDiv'),
                    attentDiv = document.getElementById('attentDiv');
                sfmcDiv.style.display = email.checked ? 'block' : 'none';
                attentDiv.style.display = email.checked ? 'none' : 'block';
            }

            let fileData = {},
                GAData = {},
                results = [];

            function readGAFile(file) {
                fileData = {};
                GAData = {};
                results = [];
                let conversions = 0,
                    revenue = 0;
                const ol = document.querySelector('#filesList ol');

                if (ol.childNodes.length > 1) {
                    ol.innerHTML = '';
                }

                for (let i = 0; i < file.length; i++) {
                    const name = file[i].name,
                        reader = new FileReader();

                    reader.onload = function (e) {
                        const data = e.target.result,
                            workbook = XLSX.read(data, {
                                type: 'binary',
                            });

                        const xlRowObj =
                            XLSX.utils.sheet_to_row_object_array(
                                workbook.Sheets['Dataset4']
                            ).length > 0
                                ? XLSX.utils.sheet_to_row_object_array(
                                      workbook.Sheets['Dataset4']
                                  )
                                : XLSX.utils.sheet_to_row_object_array(
                                      workbook.Sheets['Dataset1']
                                  );
                        console.log(xlRowObj);
                        if (document.getElementById('sms').checked) {
                            for (const key in xlRowObj) {
                                if (xlRowObj[key]['Campaign']) {
                                    fileData[key] = xlRowObj[key];
                                }
                            }
                            GAData = Object.assign({}, fileData);
                        } else
                            for (const key in xlRowObj) {
                                if (xlRowObj[key]['Transactions'] > 0) {
                                    fileData[key] = xlRowObj[key];
                                    conversions +=
                                        fileData[key]['Transactions'];
                                    revenue += fileData[key]['Revenue'];
                                }
                                GAData = {
                                    Conversions: conversions,
                                    Revenue: revenue,
                                };
                            }

                        const li = document.createElement('li');
                        li.textContent = name;
                        ol.appendChild(li);
                    };
                    reader.readAsBinaryString(file[i]);
                }
            }

            function readSFMCFile(file) {
                let SFMCData = {};
                results = [];
                let deliveries = 0,
                    opens = 0,
                    clicks = 0;
                const ol = document.querySelector('#filesList ol');

                if (ol.childNodes.length > 1) {
                    ol.innerHTML = '';
                }

                let campaignRow = [],
                    nameRow = 0;
                const dataLength = Object.keys(fileData).length;

                for (let i = 0; i < file.length; i++) {
                    const name = file[i].name,
                        reader = new FileReader();
                    reader.onload = function (e) {
                        const data = e.target.result,
                            workbook = XLSX.read(data, {
                                type: 'binary',
                            });

                        const sheet = workbook.Sheets[workbook.SheetNames[0]],
                            range = XLSX.utils.decode_range(sheet['!ref']);

                        if (dataLength > 1) {
                            for (
                                let rowNum = range.s.r;
                                rowNum <= range.e.r;
                                rowNum++
                            ) {
                                const secondCell =
                                    sheet[
                                        XLSX.utils.encode_cell({
                                            r: rowNum,
                                            c: 1,
                                        })
                                    ];
                                if (
                                    secondCell &&
                                    secondCell.v === 'Email Content Name'
                                ) {
                                    nameRow = rowNum;
                                } else {
                                    for (const key in fileData) {
                                        if (
                                            secondCell &&
                                            secondCell.v ===
                                                fileData[key]['Campaign']
                                        ) {
                                            campaignRow[key] = rowNum;
                                            const xlRowObj =
                                                XLSX.utils.sheet_to_row_object_array(
                                                    workbook.Sheets[
                                                        workbook.SheetNames[0]
                                                    ],
                                                    { range: nameRow }
                                                );
                                            fileData[key] =
                                                xlRowObj[
                                                    campaignRow[key] -
                                                        nameRow -
                                                        1
                                                ];
                                            deliveries +=
                                                fileData[key][
                                                    'Email Deliveries'
                                                ];
                                            opens +=
                                                fileData[key][
                                                    'Email Unique Opens'
                                                ];
                                            clicks +=
                                                fileData[key][
                                                    'Email Unique Clicks'
                                                ];
                                        }
                                    }
                                }
                            }
                        } else {
                            for (
                                let rowNum = range.s.r;
                                rowNum <= range.e.r;
                                rowNum++
                            ) {
                                const secondCell =
                                    sheet[
                                        XLSX.utils.encode_cell({
                                            r: rowNum,
                                            c: 1,
                                        })
                                    ];
                                if (
                                    secondCell &&
                                    secondCell.v === 'Email Content Name'
                                ) {
                                    nameRow = rowNum;
                                } else if (
                                    secondCell &&
                                    secondCell.v === fileData[0]['Campaign']
                                ) {
                                    campaignRow.push(rowNum);
                                }
                            }

                            const xlRowObj =
                                XLSX.utils.sheet_to_row_object_array(
                                    workbook.Sheets[workbook.SheetNames[0]],
                                    { range: nameRow }
                                );

                            for (let j = 0; j < campaignRow.length; j++) {
                                fileData[j] =
                                    xlRowObj[campaignRow[j] - nameRow - 1];
                                deliveries += fileData[j]['Email Deliveries'];
                                opens += fileData[j]['Email Unique Opens'];
                                clicks += fileData[j]['Email Unique Clicks'];
                            }
                        }

                        SFMCData = {
                            'Email Deliveries': deliveries,
                            'Email Unique Opens': opens,
                            'Email Unique Clicks': clicks,
                        };

                        delete fileData[0]['Email Unique Unsubscribes'];

                        fileData[0]['Send Date'] = new Date(
                            Date.UTC(0, 0, fileData[0]['Send Date'] - 1)
                        )
                            .toLocaleDateString('en-GB', {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                            })
                            .split('/')
                            .join('-');

                        if (document.getElementById('email').checked) {
                            if (dataLength > 1) {
                                const lastIndex =
                                    fileData[0][
                                        'Email Content Name'
                                    ].lastIndexOf('-');
                                fileData[0]['Email Content Name'] = fileData[0][
                                    'Email Content Name'
                                ].substring(0, lastIndex);
                                fileData[0]['Email Job ID'] = '';
                            }
                        }

                        const resultObj = Object.assign(
                            fileData[0],
                            SFMCData,
                            GAData
                        );

                        results.push(resultObj);

                        const li = document.createElement('li');
                        li.textContent = name;
                        ol.appendChild(li);
                    };
                    reader.readAsBinaryString(file[i]);
                }
            }

            function readAttentFile(file) {
                const attentData = Object.assign({}, fileData);
                results = [];

                const ol = document.querySelector('#filesList ol');

                if (ol.childNodes.length > 1) {
                    ol.innerHTML = '';
                }

                let campaignRow = [];

                for (let i = 0; i < file.length; i++) {
                    const name = file[i].name,
                        reader = new FileReader();
                    reader.onload = function (e) {
                        const data = e.target.result,
                            workbook = XLSX.read(data, {
                                type: 'binary',
                            });

                        const sheet = workbook.Sheets[workbook.SheetNames[0]],
                            range = XLSX.utils.decode_range(sheet['!ref']);

                        for (
                            let rowNum = range.s.r;
                            rowNum <= range.e.r;
                            rowNum++
                        ) {
                            const secondCell =
                                sheet[
                                    XLSX.utils.encode_cell({ r: rowNum, c: 1 })
                                ];

                            for (const key in fileData) {
                                if (
                                    secondCell &&
                                    secondCell.v
                                        .toLowerCase()
                                        .includes(
                                            attentData[key]['Campaign']
                                                .toLowerCase()
                                                .replace(/\s+/g, '')
                                        )
                                ) {
                                    campaignRow[key] = rowNum;
                                    const xlRowObj =
                                        XLSX.utils.sheet_to_row_object_array(
                                            workbook.Sheets[
                                                workbook.SheetNames[0]
                                            ]
                                        );
                                    fileData[key] =
                                        xlRowObj[campaignRow[key] - 1];

                                    delete fileData[key]['Campaign Tags'];

                                    const dataLength =
                                        Object.keys(fileData).length;

                                    if (
                                        fileData[key]['Message Name']
                                            .toLowerCase()
                                            .includes('variant')
                                    ) {
                                        fileData[key]['Message Name'] =
                                            fileData[key][
                                                'Message Name'
                                            ].replace(/variant/gi, ' VRNT');
                                    } else if (
                                        fileData[key]['Message Name']
                                            .toLowerCase()
                                            .includes('cntrl')
                                    ) {
                                        fileData[key]['Message Name'] =
                                            fileData[key][
                                                'Message Name'
                                            ].replace(/cntrl/gi, ' CTRL');
                                    }

                                    fileData[key]['Conversions'] =
                                        GAData[key]['Transactions'];
                                    fileData[key]['Revenue ($)'] =
                                        GAData[key]['Revenue'];

                                    const resultObj = Object.assign(
                                        fileData[key]
                                    );
                                    results.push(resultObj);
                                }
                            }
                        }

                        const li = document.createElement('li');
                        li.textContent = name;
                        ol.appendChild(li);
                    };
                    reader.readAsBinaryString(file[i]);
                }
            }

            function convertToCSV(args) {
                let result = '',
                    counter,
                    keys,
                    columnDelimiter,
                    lineDelimiter,
                    data;

                data = args.data || null;
                if (data == null || !data.length) return null;

                columnDelimiter = args.columnDelimiter || ',';
                lineDelimiter = args.lineDelimiter || '\n';

                keys = Object.keys(data[0]);

                result += keys.join(columnDelimiter);
                result += lineDelimiter;

                data.forEach(function (item) {
                    counter = 0;
                    keys.forEach(function (key) {
                        if (counter > 0) result += columnDelimiter;
                        result += item[key];
                        counter++;
                    });
                    result += lineDelimiter;
                });
                return result;
            }

            function downloadCSV(args) {
                let data,
                    filename,
                    link,
                    csv = convertToCSV({
                        data: results,
                    });

                if (csv == null) return;

                filename = args.filename || 'export.csv';

                if (!csv.match(/^data:text\/csv/i)) {
                    csv = 'data:text/csv;charset=utf-8,' + csv;
                }

                data = encodeURI(csv);
                link = document.createElement('a');
                link.setAttribute('href', data);
                link.setAttribute('download', filename);
                link.click();
                location.reload();
                countClicks('hit');
            }
        </script>
    </body>
</html>
